name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 0.5.0)'
        required: true
        type: string

jobs:
  build:
    name: Build ${{ matrix.os }} (${{ matrix.runtime }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux builds
          - os: ubuntu-latest
            runtime: linux-x64
            artifact-name: SlideForge-linux-x64
            package-ext: tar.gz
          - os: ubuntu-latest
            runtime: linux-arm64
            artifact-name: SlideForge-linux-arm64
            package-ext: tar.gz
          # Windows builds
          - os: windows-latest
            runtime: win-x64
            artifact-name: SlideForge-windows-x64
            package-ext: zip
          - os: windows-latest
            runtime: win-arm64
            artifact-name: SlideForge-windows-arm64
            package-ext: zip
          # macOS builds
          - os: macos-latest
            runtime: osx-x64
            artifact-name: SlideForge-macos-x64
            package-ext: zip
          - os: macos-latest
            runtime: osx-arm64
            artifact-name: SlideForge-macos-arm64
            package-ext: zip

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
      
      - name: Verify .NET SDK
        shell: bash
        run: |
          echo "Installed .NET SDK:"
          dotnet --version
          echo "Available runtimes:"
          dotnet --list-runtimes || true
          echo "Checking for runtime ${{ matrix.runtime }}:"
          dotnet --info | grep -i "${{ matrix.runtime }}" || echo "Runtime info not found in dotnet --info"

      - name: Restore dependencies
        shell: bash
        run: dotnet restore

      - name: Build
        shell: bash
        run: dotnet build --configuration Release --no-restore

      - name: Run tests
        shell: bash
        run: dotnet test --configuration Release --no-build --verbosity normal

      - name: Publish application
        shell: bash
        run: |
          echo "Publishing for runtime: ${{ matrix.runtime }}"
          dotnet publish src/Authoring.Desktop/Authoring.Desktop.csproj \
            --configuration Release \
            --runtime ${{ matrix.runtime }} \
            --self-contained true \
            --output ./publish/${{ matrix.runtime }} \
            -p:PublishSingleFile=true \
            -p:IncludeNativeLibrariesForSelfExtract=true \
            -p:EnableCompressionInSingleFile=true || {
            echo "ERROR: dotnet publish failed"
            exit 1
          }
          
          # Verify publish succeeded
          if [ ! -d "./publish/${{ matrix.runtime }}" ]; then
            echo "ERROR: Publish directory not created"
            exit 1
          fi
          
          echo "Publish directory contents:"
          ls -la "./publish/${{ matrix.runtime }}/" || true
          
          # Ensure executables have proper permissions on Unix-like systems
          if [[ "${{ matrix.runtime }}" == linux-* ]] || [[ "${{ matrix.runtime }}" == osx-* ]]; then
            EXEC_NAME="Authoring.Desktop"
            EXEC_PATH="./publish/${{ matrix.runtime }}/$EXEC_NAME"
            if [ -f "$EXEC_PATH" ]; then
              chmod +x "$EXEC_PATH"
              echo "Set execute permissions on $EXEC_NAME"
              ls -l "$EXEC_PATH"
            else
              echo "ERROR: $EXEC_NAME not found after publish for ${{ matrix.runtime }}"
              echo "Directory listing:"
              ls -la "./publish/${{ matrix.runtime }}/" || true
              echo "Looking for any files:"
              find "./publish/${{ matrix.runtime }}" -type f || true
              exit 1
            fi
          fi

      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
            VERSION=${VERSION#v}
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Package Windows
        if: startsWith(matrix.runtime, 'win-')
        shell: pwsh
        run: |
          $version = "${{ env.VERSION }}"
          $runtime = "${{ matrix.runtime }}"
          if ($runtime -eq "win-x64") {
            $arch = "x64"
          } else {
            $arch = "arm64"
          }
          $archiveName = "SlideForge-windows-$arch-v$version.zip"
          Compress-Archive -Path "./publish/${{ matrix.runtime }}/*" -DestinationPath "./$archiveName" -Force
          echo "ARCHIVE_NAME=$archiveName" >> $env:GITHUB_ENV

      - name: Verify executable permissions (Unix)
        if: startsWith(matrix.runtime, 'linux-') || startsWith(matrix.runtime, 'osx-')
        shell: bash
        run: |
          EXECUTABLE="./publish/${{ matrix.runtime }}/Authoring.Desktop"
          echo "Verifying executable at: $EXECUTABLE"
          if [ -f "$EXECUTABLE" ]; then
            # Ensure executable has proper permissions before packaging
            chmod +x "$EXECUTABLE"
            # Verify permissions are set correctly
            ls -l "$EXECUTABLE"
            if [ ! -x "$EXECUTABLE" ]; then
              echo "ERROR: Executable permissions not set correctly!"
              exit 1
            fi
            echo "✓ Execute permissions verified for ${{ matrix.runtime }}"
          else
            echo "ERROR: Executable not found at $EXECUTABLE"
            echo "This should not happen - publish step should have failed earlier"
            echo "Files in publish directory:"
            find "./publish/${{ matrix.runtime }}" -type f -exec ls -lh {} \; || true
            exit 1
          fi

      - name: Package Linux
        if: startsWith(matrix.runtime, 'linux-')
        shell: bash
        run: |
          if [ "${{ matrix.runtime }}" == "linux-x64" ]; then
            ARCH="x64"
          else
            ARCH="arm64"
          fi
          ARCHIVE_NAME="SlideForge-linux-$ARCH-v${{ env.VERSION }}.tar.gz"
          # tar preserves permissions when using -p flag or when permissions are already set
          tar -czf "$ARCHIVE_NAME" -C "./publish/${{ matrix.runtime }}" .
          echo "ARCHIVE_NAME=$ARCHIVE_NAME" >> $GITHUB_ENV
          # Verify the archive contains executable with correct permissions
          # Use tar -tzf with output capture to avoid pipe errors
          ARCHIVE_CONTENTS=$(tar -tzf "$ARCHIVE_NAME" 2>&1)
          if echo "$ARCHIVE_CONTENTS" | grep -q "Authoring.Desktop"; then
            echo "✓ Archive created successfully"
          else
            echo "ERROR: Archive does not contain Authoring.Desktop"
            echo "Archive contents:"
            echo "$ARCHIVE_CONTENTS" | head -20
            exit 1
          fi

      - name: Package macOS
        if: startsWith(matrix.runtime, 'osx-')
        shell: bash
        run: |
          if [ "${{ matrix.runtime }}" == "osx-x64" ]; then
            ARCH="x64"
          else
            ARCH="arm64"
          fi
          
          # Create .app bundle structure
          APP_NAME="SlideForge.app"
          APP_DIR="./SlideForge-$ARCH-$APP_NAME"
          EXEC_PATH="./publish/${{ matrix.runtime }}/Authoring.Desktop"
          
          # Create directory structure
          mkdir -p "$APP_DIR/Contents/MacOS"
          mkdir -p "$APP_DIR/Contents/Resources"
          
          # Create Info.plist first (needed for app structure)
          VERSION="${{ env.VERSION }}"
          printf '<?xml version="1.0" encoding="UTF-8"?>\n' > "$APP_DIR/Contents/Info.plist"
          printf '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">\n' >> "$APP_DIR/Contents/Info.plist"
          printf '<plist version="1.0">\n' >> "$APP_DIR/Contents/Info.plist"
          printf '<dict>\n' >> "$APP_DIR/Contents/Info.plist"
          printf '\t<key>CFBundleExecutable</key>\n' >> "$APP_DIR/Contents/Info.plist"
          printf '\t<string>SlideForge</string>\n' >> "$APP_DIR/Contents/Info.plist"
          printf '\t<key>CFBundleIdentifier</key>\n' >> "$APP_DIR/Contents/Info.plist"
          printf '\t<string>com.slideforge.app</string>\n' >> "$APP_DIR/Contents/Info.plist"
          printf '\t<key>CFBundleName</key>\n' >> "$APP_DIR/Contents/Info.plist"
          printf '\t<string>SlideForge</string>\n' >> "$APP_DIR/Contents/Info.plist"
          printf '\t<key>CFBundleDisplayName</key>\n' >> "$APP_DIR/Contents/Info.plist"
          printf '\t<string>SlideForge</string>\n' >> "$APP_DIR/Contents/Info.plist"
          printf '\t<key>CFBundleVersion</key>\n' >> "$APP_DIR/Contents/Info.plist"
          printf '\t<string>%s</string>\n' "$VERSION" >> "$APP_DIR/Contents/Info.plist"
          printf '\t<key>CFBundleShortVersionString</key>\n' >> "$APP_DIR/Contents/Info.plist"
          printf '\t<string>%s</string>\n' "$VERSION" >> "$APP_DIR/Contents/Info.plist"
          printf '\t<key>CFBundlePackageType</key>\n' >> "$APP_DIR/Contents/Info.plist"
          printf '\t<string>APPL</string>\n' >> "$APP_DIR/Contents/Info.plist"
          printf '\t<key>CFBundleSignature</key>\n' >> "$APP_DIR/Contents/Info.plist"
          printf '\t<string>SLDG</string>\n' >> "$APP_DIR/Contents/Info.plist"
          printf '\t<key>LSMinimumSystemVersion</key>\n' >> "$APP_DIR/Contents/Info.plist"
          printf '\t<string>10.15</string>\n' >> "$APP_DIR/Contents/Info.plist"
          printf '\t<key>NSHighResolutionCapable</key>\n' >> "$APP_DIR/Contents/Info.plist"
          printf '\t<true/>\n' >> "$APP_DIR/Contents/Info.plist"
          printf '\t<key>NSRequiresAquaSystemAppearance</key>\n' >> "$APP_DIR/Contents/Info.plist"
          printf '\t<false/>\n' >> "$APP_DIR/Contents/Info.plist"
          printf '</dict>\n' >> "$APP_DIR/Contents/Info.plist"
          printf '</plist>\n' >> "$APP_DIR/Contents/Info.plist"
          
          # Create PkgInfo file (optional but helps with app identification)
          echo "APPLSLDG" > "$APP_DIR/Contents/PkgInfo"
          
          # Copy the actual .NET executable to MacOS directory (with .bin suffix)
          cp "$EXEC_PATH" "$APP_DIR/Contents/MacOS/Authoring.Desktop.bin"
          chmod +x "$APP_DIR/Contents/MacOS/Authoring.Desktop.bin"
          
          # Create wrapper script that automatically removes quarantine on first run
          # This will be the entry point (CFBundleExecutable)
          printf '%s\n' \
            '#!/bin/bash' \
            '# Get the directory where this script is located' \
            'DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"' \
            'APP_DIR="$( cd "$DIR/../.." && pwd )"' \
            '' \
            '# Automatically remove quarantine attribute if present (Gatekeeper bypass)' \
            'if [ -n "$(xattr -l "$APP_DIR" 2>/dev/null | grep com.apple.quarantine)" ]; then' \
            '  echo "Removing Gatekeeper quarantine..."' \
            '  xattr -dr com.apple.quarantine "$APP_DIR" 2>/dev/null || true' \
            'fi' \
            '' \
            '# Run the actual executable' \
            'exec "$DIR/Authoring.Desktop.bin" "$@"' > "$APP_DIR/Contents/MacOS/SlideForge"
          
          chmod +x "$APP_DIR/Contents/MacOS/SlideForge"
          
          # Archive the .app bundle
          ARCHIVE_NAME="SlideForge-macos-$ARCH-v${{ env.VERSION }}.zip"
          # zip preserves permissions when using -X flag
          zip -X -r "$ARCHIVE_NAME" "$APP_DIR"
          echo "ARCHIVE_NAME=$ARCHIVE_NAME" >> $GITHUB_ENV
          
          # Verify the archive contains the .app bundle
          ARCHIVE_CONTENTS=$(unzip -l "$ARCHIVE_NAME" 2>&1)
          if echo "$ARCHIVE_CONTENTS" | grep -q "$APP_NAME"; then
            echo "✓ Archive created successfully with .app bundle"
          else
            echo "ERROR: Archive missing .app bundle"
            echo "$ARCHIVE_CONTENTS"
            exit 1
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: ${{ env.ARCHIVE_NAME }}
          retention-days: 30

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Get version
        id: version
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION=${VERSION#v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: List artifacts
        run: |
          find ./artifacts -type f

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ## SlideForge ${{ steps.version.outputs.VERSION }}

            ### Downloads

            #### Windows
            - **x64 (Intel/AMD)**: [SlideForge-windows-x64.zip](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/SlideForge-windows-x64-v${{ steps.version.outputs.VERSION }}.zip)
            - **ARM64**: [SlideForge-windows-arm64.zip](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/SlideForge-windows-arm64-v${{ steps.version.outputs.VERSION }}.zip)

            #### macOS
            - **x64 (Intel)**: [SlideForge-macos-x64.zip](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/SlideForge-macos-x64-v${{ steps.version.outputs.VERSION }}.zip)
            - **ARM64 (Apple Silicon)**: [SlideForge-macos-arm64.zip](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/SlideForge-macos-arm64-v${{ steps.version.outputs.VERSION }}.zip)

            #### Linux
            - **x64 (Intel/AMD)**: [SlideForge-linux-x64.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/SlideForge-linux-x64-v${{ steps.version.outputs.VERSION }}.tar.gz)
            - **ARM64**: [SlideForge-linux-arm64.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/SlideForge-linux-arm64-v${{ steps.version.outputs.VERSION }}.tar.gz)

            ### Installation
            - **Windows**: Extract the ZIP file and run `Authoring.Desktop.exe`
            - **macOS**: Extract the ZIP file and drag `SlideForge.app` to Applications folder (or run from anywhere)
              - **First time**: Double-click `SlideForge.app` - it will automatically remove quarantine
              - If Gatekeeper blocks it: Right-click `SlideForge.app` → Open → Click "Open" in security dialog
              - **Alternative**: Run `xattr -dr com.apple.quarantine SlideForge.app` in Terminal
            - **Linux**: Extract the tar.gz file and run `./Authoring.Desktop` (execute permissions are set automatically)

            ### Changes
            See commit history for details.
          files: |
            artifacts/**/*.zip
            artifacts/**/*.tar.gz
          draft: false
          prerelease: false
